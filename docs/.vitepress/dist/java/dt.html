<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式事务 | 我的博客</title>
    <meta name="description" content="德智体美劳全面发展">
    <meta name="generator" content="VitePress v2.0.0-alpha.12">
    <link rel="preload stylesheet" href="/assets/style.CZvPc2EJ.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.DUD75REu.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.DpYtQAvY.js">
    <link rel="modulepreload" href="/assets/chunks/framework.kZi0S3Z0.js">
    <link rel="modulepreload" href="/assets/java_dt.md.B9oHvMn7.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-9f75dce3><div class="VPNavBar" data-v-9f75dce3 data-v-2a96a3d0><div class="wrapper" data-v-2a96a3d0><div class="container" data-v-2a96a3d0><div class="title" data-v-2a96a3d0><div class="VPNavBarTitle has-sidebar" data-v-2a96a3d0 data-v-1e38c6bc><a class="title" href="/" data-v-1e38c6bc><!--[--><!--]--><!----><span data-v-1e38c6bc>我的博客</span><!--[--><!--]--></a></div></div><div class="content" data-v-2a96a3d0><div class="content-body" data-v-2a96a3d0><!--[--><!--]--><div class="VPNavBarSearch search" data-v-2a96a3d0><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-2a96a3d0 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-39714824 data-v-e56f3d57><!--[--><span data-v-e56f3d57>首页</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/admin/my.html" tabindex="0" data-v-39714824 data-v-e56f3d57><!--[--><span data-v-e56f3d57>关于</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/utils/index.html" tabindex="0" data-v-39714824 data-v-e56f3d57><!--[--><span data-v-e56f3d57>潘多拉</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/java/index.html" tabindex="0" data-v-39714824 data-v-e56f3d57><!--[--><span data-v-e56f3d57>Java</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/linux/index.html" tabindex="0" data-v-39714824 data-v-e56f3d57><!--[--><span data-v-e56f3d57>Linux</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-39714824 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-42cb505d><span class="text" data-v-42cb505d><!----><span data-v-42cb505d>组件</span><span class="vpi-chevron-down text-icon" data-v-42cb505d></span></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><div class="items" data-v-25a6cce8><!--[--><!--[--><div class="VPMenuLink" data-v-25a6cce8 data-v-cd834e02><a class="VPLink link" href="/dev/mysql.html" data-v-cd834e02><!--[--><span data-v-cd834e02>MySql</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-25a6cce8 data-v-cd834e02><a class="VPLink link" href="/dev/nginx.html" data-v-cd834e02><!--[--><span data-v-cd834e02>Nginx</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-25a6cce8 data-v-cd834e02><a class="VPLink link" href="/dev/redis.html" data-v-cd834e02><!--[--><span data-v-cd834e02>Redis</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-25a6cce8 data-v-cd834e02><a class="VPLink link" href="/dev/docker.html" data-v-cd834e02><!--[--><span data-v-cd834e02>Docker</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-2a96a3d0 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-2a96a3d0 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-2a96a3d0 data-v-bb2aa2f0 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bb2aa2f0><div class="item social-links" data-v-bb2aa2f0><div class="VPSocialLinks social-links-list" data-v-bb2aa2f0 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-2a96a3d0 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-2a96a3d0><div class="divider-line" data-v-2a96a3d0></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-1df9f90f data-v-8acdfeb5><div class="container" data-v-8acdfeb5><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-8acdfeb5><span class="vpi-align-left menu-icon" data-v-8acdfeb5></span><span class="menu-text" data-v-8acdfeb5>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-8acdfeb5 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-1df9f90f data-v-e7c6e512><div class="curtain" data-v-e7c6e512></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-e7c6e512><span class="visually-hidden" id="sidebar-aria-label" data-v-e7c6e512> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0 collapsible has-active" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>概览</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-d81de50c><span class="vpi-chevron-right caret-icon" data-v-d81de50c></span></div></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/java.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Java基础</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/openSource.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>开源框架</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/mp.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>MybatisPlus</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/springCloud.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>SpringCloud</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/webSocket.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>WebSocket</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/springCache.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>SpringCache</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/bitmap.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>位图</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/spring.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Spring</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/mqtt.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>MQTT</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/springTask.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>SpringTask</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/es.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>ES</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/dt.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>分布式事务</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/project.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Java项目</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/mq.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>MQ</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/java/mybatis.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Mybatis</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1df9f90f data-v-aff0b8d7><div class="VPDoc has-sidebar has-aside" data-v-aff0b8d7 data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>页面导航</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-2d0bdf9b><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _java_dt" data-v-7011f0d8><div><h1 id="分布式事务" tabindex="-1">分布式事务 <a class="header-anchor" href="#分布式事务" aria-label="Permalink to “分布式事务”">​</a></h1><blockquote><p>CAP定理、BASE理论、AC/PC模式、Seata</p></blockquote><h2 id="事务" tabindex="-1">事务 <a class="header-anchor" href="#事务" aria-label="Permalink to “事务”">​</a></h2><p>事务就是要保证一组数据库操作，要么全部成功，要么全部失败!</p><h3 id="事务的acid原则" tabindex="-1">事务的ACID原则： <a class="header-anchor" href="#事务的acid原则" aria-label="Permalink to “事务的ACID原则：”">​</a></h3><p>原子性：事务中的操作，要么全部成功，要么全部失败</p><p>一致性：事务执行前后，数据要保持一致</p><p>隔离性：多个事务之间操作互不影响</p><p>持久性：一个事务一旦提交成功，那么它对数据库的改变就是永久性的</p><p>分布式系统一致性：就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</p><h3 id="什么是分布式事务" tabindex="-1">什么是分布式事务？ <a class="header-anchor" href="#什么是分布式事务" aria-label="Permalink to “什么是分布式事务？”">​</a></h3><p>分布式事务是指在分布式系统中，涉及到不同节点或者不同的数据库的操作时，需要保证这些操作可以全部提交或者全部回滚，以保障数据的一致性和完整性。</p><h3 id="分布式事务的cap定理是什么" tabindex="-1">分布式事务的CAP定理是什么？ <a class="header-anchor" href="#分布式事务的cap定理是什么" aria-label="Permalink to “分布式事务的CAP定理是什么？”">​</a></h3><p>一致性，可用性，分区容错性 这三个不能同时存在</p><p>一致性：用户访问分布式系统中的任意节点，得到的数据必须一致。可以理解为你去建设银行a存钱，去建设银行b取钱，查到的余额必须都是一样的。 可用性：用户访问集群中的任意节点，必须得到响应，而不是超时或拒绝。可以理解为你去银行b取钱，可以查，但是银行b还没有同步你在银行a存钱的信息，所以查到的数据不准确 分区容错性：分成两个来说 分区：就是说你在建设银行a存钱了，在银行b可以查到，但银行c没有同步到你存钱的消息，这样就造成了分区。 容错：在出现分区的时候，整个系统也要持续对外提供服务。可以理解为c虽然没有同步到你存钱的消息，但他银行c没有关门，还支持你查询余额，但是结果不准确</p><h3 id="为什么分区一定出现的话-一致性和可用性只能用一个" tabindex="-1">为什么分区一定出现的话，一致性和可用性只能用一个： <a class="header-anchor" href="#为什么分区一定出现的话-一致性和可用性只能用一个" aria-label="Permalink to “为什么分区一定出现的话，一致性和可用性只能用一个：”">​</a></h3><p>在项目中，查每个微服务，肯定会出现故障导致分区一定会出现，这样的话，如果我要保证可用性，就是每个银行都可以查余额，就会出现可能同步不过来导致数据不一致，自然也就做不到上面的一致性。 如果我要保持一致性，那么就要数据准确，而可用性就必须等待数据同步过来再响应。可以理解为你如果一定要在建设银行b查你存的钱，你就需要等建设银行a同步过来数据才可以。</p><h3 id="什么是base理论" tabindex="-1">什么是BASE理论？ <a class="header-anchor" href="#什么是base理论" aria-label="Permalink to “什么是BASE理论？”">​</a></h3><p>类似中庸，主要包含三个思想。</p><p>基本可用：系统出现故障时，允损失部分可用性，即保证核心可用。</p><p>软状态：在一定时间内，允许出现中间状态，比如临时的不一致状态。</p><p>最终一致性：虽然无法保持强一致性，但是在软状态结束后，最终达成数据一致。</p><h3 id="ap模式和cp模式的区别" tabindex="-1">AP模式和CP模式的区别? <a class="header-anchor" href="#ap模式和cp模式的区别" aria-label="Permalink to “AP模式和CP模式的区别?”">​</a></h3><p>ap是可用性可分区，允许最后查询结果不一致，最后采取措施恢复即可，但我还可以用。可以理解为可以取钱，但取的钱是之前余额的，而不是刚存的。</p><p>cp是一致性可分区。必须要强一致，但不一定能用。可以理解为能查出余额，但取不出钱。</p><h3 id="什么是分支业务-什么是全局事务" tabindex="-1">什么是分支业务？什么是全局事务？ <a class="header-anchor" href="#什么是分支业务-什么是全局事务" aria-label="Permalink to “什么是分支业务？什么是全局事务？”">​</a></h3><p>每个微服务都是分支业务，有关联的各个分支事务在一起称为全局事务。而我们需要控制全部业务来完成事务要么全部成功，要么全部失败，这个就叫做事务协调者。</p><h3 id="既然不能同时实现-只能实现ap或cp-那么用哪个技术来实现呢" tabindex="-1">既然不能同时实现，只能实现AP或CP，那么用哪个技术来实现呢？ <a class="header-anchor" href="#既然不能同时实现-只能实现ap或cp-那么用哪个技术来实现呢" aria-label="Permalink to “既然不能同时实现，只能实现AP或CP，那么用哪个技术来实现呢？”">​</a></h3><p><strong>Seata</strong></p><p>RM（控制微服务的分支事务）学生：用来管理分支事务</p><p>TC（事务协调者）班长：记录每个分支事务（RM）的执行情况</p><p>TM（全局事务）老师：控制事务是提交还是回滚</p><p>可以理解为三个角色：老师告诉班长，有比赛需要报名，然后班长告诉学生，有比赛需要报名，学生可以根据自身情况告诉班长，自己要不要报名，之后班长统计后告诉老师</p><h3 id="seata提供的四种分布式事务解决方案都是什么" tabindex="-1">Seata提供的四种分布式事务解决方案都是什么？ <a class="header-anchor" href="#seata提供的四种分布式事务解决方案都是什么" aria-label="Permalink to “Seata提供的四种分布式事务解决方案都是什么？”">​</a></h3><p>早期XA模式：CP，强一致性，分为两个阶段，第一阶段是由班长(TC)告诉学生(RM)可以开始考试了，然后学生告诉班长，没问题，我们开始准备，考完的就只要告诉班长考完了就可以，先不交卷子。二阶段就是班长通知学生，你们可以提交你们的卷子了。如果一阶段只要有一个学生告诉班长，我考试失败了，那么第二阶段，班长就会告诉其他学生，不用交卷子了。因为需要一致性。</p><p>SeataXA模式：CP，强一致性，也是分为两个阶段，第一阶段是老师（TM）先告诉班长要考试了，然后老师直接告诉学生(RM)可以开始考试了，之后学生考完了或者考试失败，都告诉班长(TC)。然后等老师(TM)告诉班长可以收卷子了(检查状态情况了),然后班长检查如果都考试成功，就提交，如果有考试失败，就回滚。</p><p>两个阶段，第一个阶段各自执行但不提交，把自己的执行结果上报给TC，TC记录后，第二阶段检查状态，如果都成功就提交，如果有一个失败就回滚。能够查到准确数据，但是等待期间不可用。</p><p>AT模式（默认模式）：AP，最终一致性，也就是可用性。两个阶段，和上面一样，第一阶段是老师（TM）先告诉班长要考试了，然后老师直接告诉学生(RM)可以开始考试了，学生先把自己卷子备份一份，之后学生考完了或者考试失败，都交卷子给班长(TC)，就可以离开了。最后等老师(TM)告诉班长可以收卷子了(检查状态情况了),然后班长检查如果都考试成功，就提交，然后把备份的卷子删了，如果有考试失败，就回滚。</p><p>第一阶段就是执行前拍个快照然后提交，不会占用数据库，然后TC检查是否都成功，如果成功了就删除快照即可，如果有一个失败，就回滚，把快照之前记录的再回滚到以前。能够使用，但数据不准确。（快照是一张表，Seata官方提供了）undo_log</p><p>TCC模式：非事务性数据库，比如Redis 以人工编码的模式来模拟AT <img src="/assets/68.iOC7GEqJ.png" alt=""> 模拟快照，拍快照，删快照</p><p>代码执行：接口</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>@LocalTCC</span></span>
<span class="line"><span>public interface AccountTCCService {</span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     *  一阶段：try 预留</span></span>
<span class="line"><span>     *  @TwoPhaseBusinessAction 定义 try confirm cancel 方法名</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    @TwoPhaseBusinessAction(name = &quot;deduct&quot;, commitMethod = &quot;confirm&quot;, rollbackMethod = &quot;cancel&quot;)</span></span>
<span class="line"><span>    void deduct(@BusinessActionContextParameter(paramName = &quot;userId&quot;) Integer userId,</span></span>
<span class="line"><span>                @BusinessActionContextParameter(paramName = &quot;money&quot;) Integer money);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     *  二阶段：confirm 提交</span></span>
<span class="line"><span>     * @param ctx 可以获得 @BusinessActionContextParameter参数和xid</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    Boolean confirm(BusinessActionContext ctx);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 二阶段：cancel 回滚</span></span>
<span class="line"><span>     * @param ctx 可以获得 @BusinessActionContextParameter参数和xid</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    Boolean cancel(BusinessActionContext ctx);</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>实现类：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>@Autowired</span></span>
<span class="line"><span>private AccountMapper accountMapper;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@Autowired</span></span>
<span class="line"><span>private AccountFreezeMapper freezeMapper;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@Override</span></span>
<span class="line"><span>public void deduct(Integer userId, Integer money) {</span></span>
<span class="line"><span>    // 0.获取全局事务XID</span></span>
<span class="line"><span>    String xid = RootContext.getXID();</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    // 解决业务悬挂</span></span>
<span class="line"><span>    AccountFreeze freezeOld = freezeMapper.selectById(xid);</span></span>
<span class="line"><span>    if (freezeOld!=null) {</span></span>
<span class="line"><span>        return;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 1.拍摄快照</span></span>
<span class="line"><span>    AccountFreeze freeze = new AccountFreeze();</span></span>
<span class="line"><span>    freeze.setXid(xid);</span></span>
<span class="line"><span>    freeze.setUserId(userId);</span></span>
<span class="line"><span>    freeze.setFreezeMoney(money);</span></span>
<span class="line"><span>    freeze.setState(AccountFreeze.State.TRY);</span></span>
<span class="line"><span>    freezeMapper.insert(freeze);</span></span>
<span class="line"><span>    // 2.执行业务</span></span>
<span class="line"><span>    accountMapper.deduct(userId, money);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@Override</span></span>
<span class="line"><span>public boolean confirm(BusinessActionContext ctx) {</span></span>
<span class="line"><span>    // 1.获取全局事务XID</span></span>
<span class="line"><span>    String xid = ctx.getXid();</span></span>
<span class="line"><span>    // 2.根据xid删除快照</span></span>
<span class="line"><span>    freezeMapper.deleteById(xid);</span></span>
<span class="line"><span>    return true;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@Override</span></span>
<span class="line"><span>public boolean cancel(BusinessActionContext ctx) {</span></span>
<span class="line"><span>    // 1.获取全局事务XID</span></span>
<span class="line"><span>    String xid = ctx.getXid();</span></span>
<span class="line"><span>    // 2.查询快照</span></span>
<span class="line"><span>    AccountFreeze freeze = freezeMapper.selectById(xid);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 获取全局参数</span></span>
<span class="line"><span>    Integer userId = (Integer) ctx.getActionContext(&quot;userId&quot;);</span></span>
<span class="line"><span>    Integer money = (Integer) ctx.getActionContext(&quot;money&quot;);</span></span>
<span class="line"><span>    // 解决空回滚</span></span>
<span class="line"><span>    if (freeze == null) {</span></span>
<span class="line"><span>        freeze = new AccountFreeze();</span></span>
<span class="line"><span>        freeze.setXid(xid);</span></span>
<span class="line"><span>        freeze.setUserId(userId);</span></span>
<span class="line"><span>        freeze.setFreezeMoney(0);</span></span>
<span class="line"><span>        freeze.setState(AccountFreeze.State.CANCEL);</span></span>
<span class="line"><span>        freezeMapper.insert(freeze);</span></span>
<span class="line"><span>        return true;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 解决幂等性问题</span></span>
<span class="line"><span>    if (freeze.getState() == AccountFreeze.State.CANCEL) {</span></span>
<span class="line"><span>        return true;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 3.修改冻结金额为0，状态为2</span></span>
<span class="line"><span>    freeze.setFreezeMoney(0);</span></span>
<span class="line"><span>    freeze.setState(AccountFreeze.State.CANCEL);</span></span>
<span class="line"><span>    freezeMapper.updateById(freeze);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 4.恢复账户的钱</span></span>
<span class="line"><span>    accountMapper.refund(userId, money);</span></span>
<span class="line"><span>    return true;</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="saga模式" tabindex="-1">SAGA模式： <a class="header-anchor" href="#saga模式" aria-label="Permalink to “SAGA模式：”">​</a></h3><h4 id="xa模式优点和缺点" tabindex="-1">XA模式优点和缺点？ <a class="header-anchor" href="#xa模式优点和缺点" aria-label="Permalink to “XA模式优点和缺点？”">​</a></h4><p>优点，强一致性，实现简单，没有代码侵入。缺点是性能比较差，如果微服务1执行完了，还需要等微服务100执行完才可以提交，锁定数据库的时候别人不能用，需要等二阶段结束才释放。不涉及敏感服务，比如钱转账，不用设置成强一致性。</p><h4 id="at模式优缺点" tabindex="-1">AT模式优缺点？ <a class="header-anchor" href="#at模式优缺点" aria-label="Permalink to “AT模式优缺点？”">​</a></h4><p>假如提交后就关闭数据库了，如果数据库1执行成功了，数据库2执行失败了，就会出现短暂的数据不一致</p><h4 id="xa模式和at模式区别" tabindex="-1">XA模式和AT模式区别？ <a class="header-anchor" href="#xa模式和at模式区别" aria-label="Permalink to “XA模式和AT模式区别？”">​</a></h4><p>XA模式一阶段不提交事务，锁定资源，AT模式一阶段直接提交，不锁定资源。XA模式是强一致，而AT模式是最终一致。 <img src="/assets/69.NA4Ydt3h.png" alt=""></p><h4 id="at模式的脏写问题怎么解决" tabindex="-1">AT模式的脏写问题怎么解决？ <a class="header-anchor" href="#at模式的脏写问题怎么解决" aria-label="Permalink to “AT模式的脏写问题怎么解决？”">​</a></h4><p>AT模式脏写是说，事务1拍了快照执行后就关闭了，如果期间事务2用这个数据库事务修改删除，而事务1执行完毕后失败了，就需要回滚，又回到最开始的数据，这个时候事务2的修改删除就没用了。 可以理解为你有100元，执行业务花了10元后，拍了快照提交事务就走了，这个时候你朋友调用你的数据库，花费了10元，现在你数据库应该有80元才对，但是你执行事务最后TC检查失败，就需要回滚，恢复快照拍的数据100元！ 这个时候就会造成脏写问题。我们可以用写隔离来解决，就是说你执行业务后先不提交事务，先获取全局锁，在全局锁上面记录一下，之后提交事务，释放DB锁。等TC执行完后，才会释放全局锁。 这个时候如果你朋友用你数据库，提交事务后也需要访问全局锁，如果有占用，就会等待，等待0.3秒钟后如果还没释放，就会取消刚才所有操作，然后释放锁。</p><h4 id="rm执行成功还是失败-怎么告诉tc呢" tabindex="-1">RM执行成功还是失败，怎么告诉TC呢？ <a class="header-anchor" href="#rm执行成功还是失败-怎么告诉tc呢" aria-label="Permalink to “RM执行成功还是失败，怎么告诉TC呢？”">​</a></h4><p>TC就是Seata框架，我们都知道每个微服务都绑定了Nacos,所以这里把TC也绑定给Nacos，然后RM就可以通过Nacos来告诉TC</p><h4 id="怎么让seata连接到nacos" tabindex="-1">怎么让Seata连接到Nacos? <a class="header-anchor" href="#怎么让seata连接到nacos" aria-label="Permalink to “怎么让Seata连接到Nacos?”">​</a></h4><p>• <a href="https://seata.apache.org/" target="_blank" rel="noreferrer">下载Seata</a> 解压后在bin目录下下运行，如果运行失败的话就修改一下配置文件，把内存值调低一点。 <img src="/assets/70.Bo1Xad9F.png" alt=""> 修改配置 <img src="/assets/71.CxDQzppI.png" alt=""><img src="/assets/72.COW6DKi0.png" alt=""> 这里配置好了，我们就可以调用微服务去找Seata了，导入依赖：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span></span>
<span class="line"><span>    &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;</span></span>
<span class="line"><span>    &lt;exclusions&gt;</span></span>
<span class="line"><span>        &lt;!--版本较低，1.3.0，因此排除--&gt;</span></span>
<span class="line"><span>        &lt;exclusion&gt;</span></span>
<span class="line"><span>            &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;</span></span>
<span class="line"><span>            &lt;groupId&gt;io.seata&lt;/groupId&gt;</span></span>
<span class="line"><span>        &lt;/exclusion&gt;</span></span>
<span class="line"><span>    &lt;/exclusions&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>&lt;!--seata starter 采用1.4.2版本--&gt;</span></span>
<span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;io.seata&lt;/groupId&gt;</span></span>
<span class="line"><span>    &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;</span></span>
<span class="line"><span>    &lt;version&gt;1.4.2&lt;/version&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span></code></pre></div><p>然后在每个微服务中添加配置文件：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>seata:</span></span>
<span class="line"><span>  registry: # TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址</span></span>
<span class="line"><span>    # 参考tc服务自己的registry.conf中的配置</span></span>
<span class="line"><span>    type: nacos</span></span>
<span class="line"><span>    nacos: # tc</span></span>
<span class="line"><span>      server-addr: 127.0.0.1:8848</span></span>
<span class="line"><span>      namespace: &quot;&quot;</span></span>
<span class="line"><span>      group: DEFAULT_GROUP</span></span>
<span class="line"><span>      application: seata-tc-server # tc服务在nacos中的服务名称</span></span>
<span class="line"><span>      cluster: default</span></span>
<span class="line"><span>  tx-service-group: seata-demo # 事务组，根据这个获取tc服务的cluster名称</span></span>
<span class="line"><span>  service:</span></span>
<span class="line"><span>    vgroup-mapping: # 事务组与TC服务cluster的映射关系</span></span>
<span class="line"><span>      seata-demo: default</span></span></code></pre></div><p>微服务如何根据这些配置寻找TC的地址呢？ <img src="/assets/73.X3JVl8Aq.png" alt=""></p><h4 id="怎么让微服务开启xa模式" tabindex="-1">怎么让微服务开启XA模式？ <a class="header-anchor" href="#怎么让微服务开启xa模式" aria-label="Permalink to “怎么让微服务开启XA模式？”">​</a></h4><p>在配置文件中添加：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>seata:</span></span>
<span class="line"><span>  data-source-proxy-mode: XA</span></span></code></pre></div><p>然后在入口添加全局事务注解</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>@GlobalTransactional //开启全局事务</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/java/es.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Previous page</span><span class="title" data-v-e257564d>ES</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/java/project.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>Java项目</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-1df9f90f data-v-c3855bb3><div class="container" data-v-c3855bb3><p class="message" data-v-c3855bb3><img src="../public/images/03.png" alt="Logo" style="height: 180px; vertical-align: middle; margin-right: 8px;"> hello world</p><p class="copyright" data-v-c3855bb3>© 2025 本博客已省略 9999 个 bug</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"admin_my.md\":\"BBDaMPgD\",\"dev_docker.md\":\"CZ1Ows3t\",\"dev_mysql.md\":\"B9i0tOVS\",\"dev_nginx.md\":\"BYrY6LqE\",\"dev_redis.md\":\"8QFZQHWt\",\"index.md\":\"C8ZZ54zT\",\"java_bitmap.md\":\"Da1EIbqE\",\"java_dt.md\":\"B9oHvMn7\",\"java_es.md\":\"CbGsdVa3\",\"java_index.md\":\"B8trZM9W\",\"java_java.md\":\"D0bYkbBw\",\"java_mp.md\":\"D77jeMbt\",\"java_mq.md\":\"6nIMkIhz\",\"java_mqtt.md\":\"CBxS-T0R\",\"java_mybatis.md\":\"cx4fa_tH\",\"java_opensource.md\":\"B_KSq-C7\",\"java_project.md\":\"Dl41NjUO\",\"java_spring.md\":\"BYI60RGT\",\"java_springcache.md\":\"DLKoybBt\",\"java_springcloud.md\":\"CIOOmLFk\",\"java_springtask.md\":\"ctM-9Lty\",\"java_websocket.md\":\"N6rrX5BY\",\"linux_index.md\":\"CxIpGxZX\",\"linux_linux.md\":\"Bs0mqmQI\",\"utils_ai.md\":\"DV0BtycB\",\"utils_index.md\":\"0vgYDxqf\",\"utils_movie.md\":\"bltkneiK\",\"utils_pdl.md\":\"u3a8y3Ew\",\"utils_util.md\":\"BDGzHmF7\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"我的博客\",\"description\":\"德智体美劳全面发展\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"首页\",\"link\":\"/\"},{\"text\":\"关于\",\"link\":\"/admin/my\"},{\"text\":\"潘多拉\",\"link\":\"/utils/index\"},{\"text\":\"Java\",\"link\":\"/java/index\"},{\"text\":\"Linux\",\"link\":\"/linux/index\"},{\"text\":\"组件\",\"items\":[{\"text\":\"MySql\",\"link\":\"/dev/mysql\"},{\"text\":\"Nginx\",\"link\":\"/dev/nginx\"},{\"text\":\"Redis\",\"link\":\"/dev/redis\"},{\"text\":\"Docker\",\"link\":\"/dev/docker\"}]}],\"search\":{\"provider\":\"local\"},\"outlineTitle\":\"页面导航\",\"footer\":{\"message\":\"<img src=\\\"../public/images/03.png\\\" alt=\\\"Logo\\\" style=\\\"height: 180px; vertical-align: middle; margin-right: 8px;\\\"> hello world\",\"copyright\":\"© 2025 本博客已省略 9999 个 bug\"},\"sidebar\":{\"/\":[],\"/utils/\":[{\"text\":\"概览\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"Ai\",\"link\":\"/utils/ai\"},{\"text\":\"影视\",\"link\":\"/utils/movie\"},{\"text\":\"工具\",\"link\":\"/utils/util\"},{\"text\":\"潘多拉\",\"link\":\"/utils/pdl\"}]}],\"/java/\":[{\"text\":\"概览\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"Java基础\",\"link\":\"/java/java\"},{\"text\":\"开源框架\",\"link\":\"/java/openSource\"},{\"text\":\"MybatisPlus\",\"link\":\"/java/mp\"},{\"text\":\"SpringCloud\",\"link\":\"/java/springCloud\"},{\"text\":\"WebSocket\",\"link\":\"/java/webSocket\"},{\"text\":\"SpringCache\",\"link\":\"/java/springCache.md\"},{\"text\":\"位图\",\"link\":\"/java/bitmap\"},{\"text\":\"Spring\",\"link\":\"/java/spring\"},{\"text\":\"MQTT\",\"link\":\"/java/mqtt\"},{\"text\":\"SpringTask\",\"link\":\"/java/springTask\"},{\"text\":\"ES\",\"link\":\"/java/es\"},{\"text\":\"分布式事务\",\"link\":\"/java/dt\"},{\"text\":\"Java项目\",\"link\":\"/java/project\"},{\"text\":\"MQ\",\"link\":\"/java/mq\"},{\"text\":\"Mybatis\",\"link\":\"/java/mybatis\"}]}],\"/linux/\":[{\"text\":\"Linux基础\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"常用命令\",\"link\":\"/linux/commands\"},{\"text\":\"文件系统\",\"link\":\"/linux/filesystem\"},{\"text\":\"权限管理\",\"link\":\"/linux/permissions\"}]},{\"text\":\"Linux高级\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"Shell脚本\",\"link\":\"/linux/shell\"},{\"text\":\"系统管理\",\"link\":\"/linux/administration\"}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/vuejs/vitepress\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false,\"additionalConfig\":{}}");</script>
    
  </body>
</html>